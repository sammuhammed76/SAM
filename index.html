<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SAM</title>
<meta name="theme-color" content="#0a84ff">
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --blue:#0a84ff;
  --green:#32d74b;
  --red:#ff3b30;
  --bg:#f7f8fc;
  --text:#111;
  --card:#fff;
}
body.dark{
  --bg:#121212;
  --text:#eee;
  --card:#1e1e1e;
}
*{box-sizing:border-box}
body{font-family:-apple-system,system-ui,Segoe UI,Roboto,sans-serif;margin:0;
  background:var(--bg);color:var(--text);transition:background .3s,color .3s;}
header{background:var(--blue);color:#fff;padding:14px;text-align:center;font-size:20px;
  position:sticky;top:0;z-index:2}
main{padding:16px;display:grid;gap:16px}
.card{background:var(--card);border-radius:12px;padding:14px;
  box-shadow:0 2px 6px rgba(0,0,0,.08)}
input,select,textarea{width:100%;padding:10px;margin:6px 0;border-radius:10px;
  border:1px solid #dcdcdc;background:#fff;color:#000}
body.dark input,body.dark textarea{background:#333;color:#eee;border:1px solid #555}
button{padding:10px 14px;border:0;border-radius:10px;background:var(--blue);color:#fff;font-weight:600}
button.ghost{background:#eef3ff;color:var(--blue)}
button.danger{background:var(--red);color:#fff}
button.switch{background:#555;}
table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
tr.profit{background:rgba(50,215,75,0.08)}
tr.loss{background:rgba(255,59,48,0.08)}
.total{background:#eef3ff;padding:10px;border-radius:10px;margin-top:8px}
.chart-container{position:relative;height:250px;width:100%}
body.dark .total{background:#222}
</style>
</head>
<body>
<header>ðŸš› SAM â€” TÄ±r Takip v2.5</header>
<main>

<div class="card">
  <h3>Yeni KayÄ±t</h3>
  <input id="date" type="date">
  <input id="plate" list="plateList" placeholder="Plaka (Ã¶rn: 34ABC123)">
  <datalist id="plateList"></datalist>
  <input id="client" list="clientList" placeholder="MÃ¼ÅŸteri">
  <datalist id="clientList"></datalist>
  <input id="income" type="number" placeholder="Gelir (â‚º)">
  <input id="expense" type="number" placeholder="Gider (â‚º)">
  <textarea id="note" placeholder="AÃ§Ä±klama"></textarea>
  <button id="btnAdd">Kaydet</button>
</div>

<div class="card">
  <h3>Filtre & DÄ±ÅŸa Aktar</h3>
  <input id="qPlate" placeholder="Plaka ara">
  <input id="qClient" placeholder="MÃ¼ÅŸteri ara">
  <button class="ghost" id="btnFilter">Filtrele</button>
  <button class="ghost" id="btnClear">Temizle</button>
  <button class="ghost" id="btnCsv">CSV DÄ±ÅŸa Aktar</button>
  <button class="switch" id="btnDark">ðŸŒ™ KaranlÄ±k Mod</button>
  <div class="total" id="summary"></div>
</div>

<div class="card">
  <h3>KayÄ±tlar</h3>
  <table id="table">
    <thead><tr><th>Tarih</th><th>Plaka</th><th>MÃ¼ÅŸteri</th><th>Gelir</th><th>Gider</th><th>KÃ¢r</th><th>Not</th><th></th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<div class="card">
  <h3>AylÄ±k Rapor</h3>
  <canvas id="chart"></canvas>
</div>

<script>
/* ====== YardÄ±mcÄ±lar ====== */
const LS = "samDataV4";
const LSLIST = "samLists";
function money(n){ return (n||0).toLocaleString("tr-TR"); }
function saveData(){ localStorage.setItem(LS, JSON.stringify(state.data)); }
function saveLists(){ localStorage.setItem(LSLIST, JSON.stringify(state.lists)); }

/* ====== DOM HazÄ±r olunca ====== */
document.addEventListener("DOMContentLoaded", () => {
  // TÃ¼m elemanlarÄ± elle seÃ§ (Safari global yapmaz)
  const el = {
    date: document.getElementById("date"),
    plate: document.getElementById("plate"),
    client: document.getElementById("client"),
    income: document.getElementById("income"),
    expense: document.getElementById("expense"),
    note: document.getElementById("note"),
    qPlate: document.getElementById("qPlate"),
    qClient: document.getElementById("qClient"),
    plateList: document.getElementById("plateList"),
    clientList: document.getElementById("clientList"),
    tblBody: document.querySelector("#table tbody"),
    summary: document.getElementById("summary"),
    chart: document.getElementById("chart"),
    // butonlar
    btnAdd: document.getElementById("btnAdd"),
    btnFilter: document.getElementById("btnFilter"),
    btnClear: document.getElementById("btnClear"),
    btnCsv: document.getElementById("btnCsv"),
    btnDark: document.getElementById("btnDark"),
  };

  // Uygulama durumu
  window.state = {
    data: JSON.parse(localStorage.getItem(LS) || "[]"),
    lists: JSON.parse(localStorage.getItem(LSLIST) || '{"plates":[],"clients":[]}'),
    chart: null
  };

  /* ---- Otomatik tamamlama listelerini doldur ---- */
  function fillLists(){
    el.plateList.innerHTML = state.lists.plates.map(p=>`<option value="${p}">`).join("");
    el.clientList.innerHTML = state.lists.clients.map(c=>`<option value="${c}">`).join("");
  }

  /* ---- Tablo ve Ã¶zet ---- */
  function render(){
    el.tblBody.innerHTML = "";
    let sumIn = 0, sumEx = 0;
    let list = [...state.data];

    const qp = (el.qPlate.value||"").toLowerCase();
    const qc = (el.qClient.value||"").toLowerCase();
    if(qp) list = list.filter(x => (x.plate||"").toLowerCase().includes(qp));
    if(qc) list = list.filter(x => (x.client||"").toLowerCase().includes(qc));

    list.sort((a,b)=> b.date.localeCompare(a.date));

    list.forEach(r=>{
      const k = (r.income||0) - (r.expense||0);
      sumIn += (r.income||0); sumEx += (r.expense||0);
      const tr = document.createElement("tr");
      tr.className = k>=0 ? "profit" : "loss";
      tr.innerHTML = `
        <td>${r.date||""}</td>
        <td>${r.plate||""}</td>
        <td>${r.client||""}</td>
        <td>${money(r.income)} â‚º</td>
        <td>${money(r.expense)} â‚º</td>
        <td>${money(k)} â‚º</td>
        <td>${(r.note||"").replace(/</g,"&lt;")}</td>
        <td><button class="danger" data-id="${r.id}">Sil</button></td>
      `;
      // sil
      tr.querySelector("button").addEventListener("click", (e)=>{
        const id = e.currentTarget.getAttribute("data-id");
        if(confirm("Silinsin mi?")){
          state.data = state.data.filter(x => String(x.id)!==String(id));
          saveData(); render(); drawChart();
        }
      });
      el.tblBody.appendChild(tr);
    });

    el.summary.innerHTML = `Toplam Gelir: <b>${money(sumIn)} â‚º</b> â€” Gider: <b>${money(sumEx)} â‚º</b> â€” KÃ¢r: <b>${money(sumIn-sumEx)} â‚º</b>`;
    drawChart();
  }

  /* ---- Grafik ---- */
  function drawChart(){
    const months = {};
    state.data.forEach(r=>{
      if(!r.date) return;
      const [y,m] = r.date.split("-");
      const key = `${y}-${m}`;
      if(!months[key]) months[key] = {gelir:0, gider:0};
      months[key].gelir += (+r.income||0);
      months[key].gider += (+r.expense||0);
    });
    const labels = Object.keys(months).sort();
    const gelir = labels.map(k=>months[k].gelir);
    const gider = labels.map(k=>months[k].gider);

    if(state.chart) { state.chart.destroy(); state.chart = null; }
    state.chart = new Chart(el.chart, {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label:"Gelir", data: gelir, backgroundColor:"rgba(50,215,75,0.6)" },
          { label:"Gider", data: gider, backgroundColor:"rgba(255,59,48,0.6)" }
        ]
      },
      options: { plugins:{ legend:{ position:"bottom" } }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  /* ---- KayÄ±t ekle ---- */
  function add(){
    const r = {
      id: Date.now(),
      date: el.date.value,
      plate: (el.plate.value||"").trim(),
      client: (el.client.value||"").trim(),
      income: +el.income.value || 0,
      expense: +el.expense.value || 0,
      note: (el.note.value||"").trim()
    };
    if(!r.date || !r.plate){ alert("Tarih ve plaka zorunlu"); return; }

    state.data.push(r);
    if(r.plate && !state.lists.plates.includes(r.plate)) state.lists.plates.push(r.plate);
    if(r.client && !state.lists.clients.includes(r.client)) state.lists.clients.push(r.client);

    saveData(); saveLists(); fillLists(); render();

    // formu temizle
    el.date.value = el.plate.value = el.client.value = el.income.value = el.expense.value = el.note.value = "";
  }

  /* ---- CSV dÄ±ÅŸa aktar ---- */
  function exportCsv(){
    const rows = ["Tarih,Plaka,MÃ¼ÅŸteri,Gelir,Gider,KÃ¢r,Not"];
    state.data.forEach(r=>{
      const k = (r.income||0)-(r.expense||0);
      rows.push(`${r.date||""},${r.plate||""},${r.client||""},${r.income||0},${r.expense||0},${k},"${(r.note||"").replace(/"/g,'""')}"`);
    });
    const blob = new Blob([rows.join("\n")], {type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "sam_kayitlar.csv";
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }

  /* ---- Tema ---- */
  function applyTheme(){
    if(localStorage.getItem("samTheme")==="dark") document.body.classList.add("dark");
    else document.body.classList.remove("dark");
  }
  function toggleDark(){
    const nowDark = !document.body.classList.contains("dark");
    document.body.classList.toggle("dark", nowDark);
    localStorage.setItem("samTheme", nowDark ? "dark" : "light");
  }

  /* ---- Olay baÄŸla ---- */
  el.btnAdd.addEventListener("click", add);
  el.btnFilter.addEventListener("click", render);
  el.btnClear.addEventListener("click", ()=>{ el.qPlate.value=""; el.qClient.value=""; render(); });
  el.btnCsv.addEventListener("click", exportCsv);
  el.btnDark.addEventListener("click", toggleDark);

  /* ---- Ä°lk yÃ¼kleme ---- */
  applyTheme();
  fillLists();
  render();
});
</script>
