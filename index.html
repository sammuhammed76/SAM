<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>SAM</title>
<meta name="theme-color" content="#0a84ff">
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* ===== Design Tokens ===== */
:root{
  --blue:#0a84ff; --blue-weak:#eaf0ff;
  --green:#23c552; --red:#ff3b30;
  --bg:#f5f6fb; --card:#ffffff; --text:#0f1222; --muted:#eef3ff;
  --border:#e7e9f3; --shadow:0 8px 24px rgba(15,18,34,.06);
  --radius:14px; --pad:14px;
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#111216; --card:#16181f; --text:#eaeef8; --muted:#1e2230; --border:#242839; --blue-weak:#1a2544; --shadow:0 8px 24px rgba(0,0,0,.4) }
}
body.dark{
  --bg:#111216; --card:#16181f; --text:#eaeef8; --muted:#1e2230; --border:#242839; --blue-weak:#1a2544; --shadow:0 8px 24px rgba(0,0,0,.4)
}

/* ===== Base ===== */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--text);
  font-family:ui-rounded, -apple-system, system-ui, "SF Pro Rounded", "Segoe UI", Roboto, Arial, sans-serif;
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  transition:background .25s ease,color .25s ease;
}
header{
  position:sticky; top:0; z-index:5;
  background:linear-gradient(135deg, var(--blue), #6aa9ff);
  color:#fff; padding:16px 20px;
  font-size:20px; font-weight:700;
}
nav.tabs{
  position:sticky; top:56px; z-index:4;
  display:flex; gap:10px; overflow:auto; -webkit-overflow-scrolling:touch;
  padding:10px 16px; background:var(--muted);
  border-bottom:1px solid var(--border);
}
nav.tabs button{
  border:1px solid transparent; border-radius:999px; padding:10px 14px;
  background:var(--blue-weak); color:var(--blue); font-weight:700; letter-spacing:.2px;
}
nav.tabs button.active{ background:var(--blue); color:#fff; box-shadow:0 6px 20px rgba(10,132,255,.25) }
main{ padding:16px; display:grid; gap:16px; max-width:920px; margin:0 auto }

.card{
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
  padding:var(--pad); box-shadow:var(--shadow);
}
h3{ margin:.2rem 0 10px; font-size:18px }

input,textarea{
  width:100%; padding:12px 12px; margin:6px 0;
  border-radius:12px; border:1px solid var(--border); background:#fff; color:#111;
  outline:none; transition:box-shadow .15s,border-color .15s,background .3s,color .3s;
}
body.dark input, body.dark textarea{ background:#1b1e27; color:var(--text); border-color:#2a2f44 }
input:focus, textarea:focus{ box-shadow:0 0 0 4px rgba(10,132,255,.16); border-color:#7fb3ff }

button{
  padding:12px 16px; border:0; border-radius:12px; cursor:pointer;
  background:var(--blue); color:#fff; font-weight:700; letter-spacing:.2px;
  transition:transform .05s ease, filter .2s ease;
}
button:active{ transform:translateY(1px) }
button.ghost{ background:var(--blue-weak); color:var(--blue) }
button.danger{ background:var(--red) }
button.pill{ border-radius:999px }
.actions{ display:flex; gap:8px; flex-wrap:wrap }

/* Tables */
table{ width:100%; border-collapse:collapse; font-size:14px; border-radius:12px; overflow:hidden }
th,td{ padding:10px 10px; border-bottom:1px solid var(--border); vertical-align:top }
thead th{ position:sticky; top:0; background:var(--muted); z-index:1 }
tbody tr:nth-child(even){ background:rgba(0,0,0,.02) }
.num{ text-align:right; font-variant-numeric:tabular-nums }
.kar{ display:inline-block; padding:3px 8px; border-radius:999px; font-weight:700 }
.row-profit{ background:rgba(35,197,82,.06) }
.row-loss{ background:rgba(255,59,48,.06) }
.kar.profit{ background:rgba(35,197,82,.15); color:#0a7a2f }
.kar.loss{ background:rgba(255,59,48,.15); color:#b10e00 }

.total{
  background:var(--muted); padding:12px; border-radius:12px; display:flex; gap:10px; flex-wrap:wrap
}
.chip{ background:#fff; border:1px solid var(--border); padding:6px 10px; border-radius:999px; box-shadow:var(--shadow) }
body.dark .chip{ background:#171a22 }

/* Small helpers */
.small{ font-size:12px; opacity:.7 }
.hr{ height:1px; background:var(--border); margin:12px 0 }

.badge{ background:var(--blue-weak); color:var(--blue); padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700 }
  /* ==== SAM Brand Header ==== */
.brand {
  position: sticky; top: 0; z-index: 6;
  background:
    radial-gradient(1200px 300px at 50% -40%, rgba(10,132,255,.35), transparent 60%),
    linear-gradient(135deg, #0a84ff, #6aa9ff);
  color: #fff;
  padding: 22px 20px;
  display: grid; place-items: center;
  border-bottom: 1px solid rgba(255,255,255,.15);
  box-shadow: 0 12px 30px rgba(10,132,255,.25);
}
.brand .logo {
  display: inline-grid; grid-auto-flow: column; gap: 12px; align-items: center;
  backdrop-filter: blur(6px);
  background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
  border: 1px solid rgba(255,255,255,.25);
  padding: 10px 16px; border-radius: 16px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.35), 0 10px 30px rgba(0,0,0,.12);
}
.brand .mark {
  width: 34px; height: 34px; border-radius: 10px;
  background: conic-gradient(from 210deg, #79b4ff, #0a84ff, #6aa9ff, #79b4ff);
  box-shadow: inset 0 2px 8px rgba(255,255,255,.35), 0 6px 16px rgba(0,0,0,.25);
  display: grid; place-items: center; color:#fff; font-weight: 800; letter-spacing:.5px;
  font-family: ui-rounded, -apple-system, "SF Pro Rounded", system-ui, sans-serif;
}
.brand .text {
  font-family: ui-rounded, -apple-system, "SF Pro Rounded", system-ui, sans-serif;
  font-weight: 900; letter-spacing: 2.5px; text-transform: uppercase;
  font-size: 20px;
  text-shadow: 0 2px 12px rgba(0,0,0,.25);
}
</style>
</head>
<body>
<header class="brand">
  <div class="logo" aria-label="SAM">
    <div class="mark">S</div>
    <div class="text">SAM</div>
  </div>
</header>

<nav class="tabs">
  <button data-tab="add" class="active pill">Kayƒ±t Ekle</button>
  <button data-tab="list" class="pill">Kayƒ±tlar</button>
  <button data-tab="reports" class="pill">Raporlar</button>
  <button data-tab="service" class="pill">Bakƒ±m</button>
  <button data-tab="settings" class="pill">Ayarlar</button>
</nav>

<main>
  <!-- KAYIT EKLE -->
  <section class="tab active" id="tab-add">
    <div class="card">
      <h3>Yeni Kayƒ±t</h3>
      <input id="date" type="date">
      <input id="plate" list="plateList" placeholder="Plaka (√∂rn: 34ABC123)">
      <datalist id="plateList"></datalist>
      <div class="actions">
        <input id="income" type="number" inputmode="decimal" placeholder="Gelir (‚Ç∫)" style="flex:1">
        <input id="expense" type="number" inputmode="decimal" placeholder="Gider (‚Ç∫)" style="flex:1">
      </div>
      <textarea id="note" placeholder="A√ßƒ±klama (opsiyonel)"></textarea>
      <div class="actions">
        <input id="service" type="date" placeholder="Muayene/Bakƒ±m Tarihi (ops.)" style="flex:1">
        <button id="btnAdd" class="pill" style="flex:1">‚ûï Kaydet</button>
      </div>
      <div class="small">Zorunlu alanlar: Tarih, Plaka</div>
    </div>
  </section>

  <!-- KAYITLAR -->
  <section class="tab" id="tab-list">
    <div class="card">
      <h3>Filtre & Dƒ±≈üa Aktar</h3>
      <div class="actions">
        <input id="qPlate" placeholder="Plaka ara" style="flex:2">
        <button class="ghost pill" id="btnFilter">üîé Filtrele</button>
        <button class="ghost pill" id="btnClear">üßπ Temizle</button>
        <button class="ghost pill" id="btnCsv">‚¨áÔ∏è CSV</button>
      </div>
      <div class="total" id="summary"></div>
    </div>

    <div class="card">
      <h3>Kayƒ±tlar</h3>
      <table id="table">
        <thead>
          <tr><th>Tarih</th><th>Plaka</th><th class="num">Gelir</th><th class="num">Gider</th><th class="num">K√¢r</th><th>Not</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- RAPORLAR -->
  <section class="tab" id="tab-reports">
    <div class="card">
      <h3>Aylƒ±k Rapor</h3>
      <canvas id="chart" height="300"></canvas>
    </div>
  </section>

  <!-- BAKIM -->
  <section class="tab" id="tab-service">
    <div class="card">
      <h3>Bakƒ±mlar / Muayeneler <span class="badge">30 g√ºn uyarƒ±</span></h3>
      <table id="tblSvc">
        <thead><tr><th>Tarih</th><th>Plaka</th><th>Tip</th><th>Aksiyon</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="hr"></div>
      <button class="ghost pill" id="btnAllIcs">üìÖ T√ºm bakƒ±mlarƒ± .ics indir</button>
    </div>
  </section>

  <!-- AYARLAR -->
  <section class="tab" id="tab-settings">
    <div class="card">
      <h3>G√∂r√ºn√ºm</h3>
      <div class="actions">
        <button id="btnDark" class="pill">üåô Karanlƒ±k Mod</button>
      </div>
      <p class="small">Tema tercihin ve son se√ßtiƒüin sekme cihazƒ±nda saklanƒ±r.</p>
    </div>
  </section>
</main>

<script>
/* ====== Ana durum / sabitler (JS mantƒ±ƒüƒ± aynƒ±, g√∂rsel sƒ±nƒ±flar g√ºncellendi) ====== */
const LS = "samDataV6";
const LSLIST = "samLists";
const LSTAB = "samTab";
const LSTHEME = "samTheme";

const state = {
  data: JSON.parse(localStorage.getItem(LS) || "[]"),
  lists: JSON.parse(localStorage.getItem(LSLIST) || '{"plates":[]}'),
  chart: null
};
function save(){ localStorage.setItem(LS, JSON.stringify(state.data)); }
function saveLists(){ localStorage.setItem(LSLIST, JSON.stringify(state.lists)); }
function money(n){ return (n||0).toLocaleString("tr-TR"); }

/* Sekmeler */
const tabs = document.querySelectorAll("nav.tabs button");
const sections = {
  add: document.getElementById("tab-add"),
  list: document.getElementById("tab-list"),
  reports: document.getElementById("tab-reports"),
  service: document.getElementById("tab-service"),
  settings: document.getElementById("tab-settings"),
};
function openTab(name){
  tabs.forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
  Object.entries(sections).forEach(([k,el])=> el.classList.toggle("active", k===name));
  localStorage.setItem(LSTAB, name);
  if(name==="reports") drawChart();
  if(name==="service") renderSvc();
}
tabs.forEach(b=> b.addEventListener("click", ()=> openTab(b.dataset.tab)));
openTab(localStorage.getItem(LSTAB) || "add");

/* Tema */
function applyTheme(){
  const dark = localStorage.getItem(LSTHEME)==="dark" || (localStorage.getItem(LSTHEME)===null && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
  document.body.classList.toggle("dark", dark);
}
applyTheme();
document.getElementById("btnDark").addEventListener("click", ()=>{
  const dark = !document.body.classList.contains("dark");
  document.body.classList.toggle("dark", dark);
  localStorage.setItem(LSTHEME, dark ? "dark" : "light");
});

/* Otomatik tamamlama (plaka) */
function fillLists(){
  const dl = document.getElementById("plateList");
  dl.innerHTML = (state.lists.plates||[]).map(p=>`<option value="${p}">`).join("");
}
fillLists();

/* Elemanlar */
const el = {
  date: document.getElementById("date"),
  plate: document.getElementById("plate"),
  income: document.getElementById("income"),
  expense: document.getElementById("expense"),
  note: document.getElementById("note"),
  service: document.getElementById("service"),
  qPlate: document.getElementById("qPlate"),
  tblBody: document.querySelector("#table tbody"),
  summary: document.getElementById("summary"),
  chart: document.getElementById("chart"),
  btnAdd: document.getElementById("btnAdd"),
  btnFilter: document.getElementById("btnFilter"),
  btnClear: document.getElementById("btnClear"),
  btnCsv: document.getElementById("btnCsv"),
  tblSvcBody: document.querySelector("#tblSvc tbody"),
  btnAllIcs: document.getElementById("btnAllIcs"),
};

/* Kayƒ±t ekle */
function addRecord(){
  const r = {
    id: Date.now(),
    date: el.date.value,
    plate: (el.plate.value||"").trim(),
    income: +el.income.value || 0,
    expense: +el.expense.value || 0,
    note: (el.note.value||"").trim(),
    service: el.service.value || ""
  };
  if(!r.date || !r.plate){ alert("Tarih ve plaka zorunlu"); return; }

  state.data.push(r);
  if(r.plate && !state.lists.plates.includes(r.plate)) state.lists.plates.push(r.plate);
  save(); saveLists(); fillLists();

  el.date.value = el.plate.value = el.income.value = el.expense.value = el.note.value = el.service.value = "";
  openTab("list");
  renderTable(); drawChart(); renderSvc();
}
document.getElementById("btnAdd").addEventListener("click", addRecord);

/* Liste / filtre / CSV */
function renderTable(){
  el.tblBody.innerHTML = "";
  let list = [...state.data];
  const qp = (el.qPlate.value||"").toLowerCase();
  if(qp) list = list.filter(x => (x.plate||"").toLowerCase().includes(qp));
  list.sort((a,b) => b.date.localeCompare(a.date));

  let sumIn=0, sumEx=0;
  list.forEach(r=>{
    const k=(r.income||0)-(r.expense||0);
    sumIn+=(r.income||0); sumEx+=(r.expense||0);
    const tr=document.createElement("tr");
    tr.className = k>=0 ? "row-profit" : "row-loss";
    tr.innerHTML = `
      <td>${r.date||""}</td>
      <td>${r.plate||""}</td>
      <td class="num">${money(r.income)} ‚Ç∫</td>
      <td class="num">${money(r.expense)} ‚Ç∫</td>
      <td class="num"><span class="kar ${k>=0?'profit':'loss'}">${money(k)} ‚Ç∫</span></td>
      <td>${(r.note||"").replace(/</g,"&lt;")}</td>
      <td><button class="danger pill" data-id="${r.id}">Sil</button></td>`;
    tr.querySelector("button").addEventListener("click",(e)=>{
      const id = e.currentTarget.getAttribute("data-id");
      if(confirm("Bu kayƒ±t silinsin mi?")){
        state.data = state.data.filter(x => String(x.id)!==String(id));
        save(); renderTable(); drawChart(); renderSvc();
      }
    });
    el.tblBody.appendChild(tr);
  });

  el.summary.innerHTML = `
    <span class="chip">Gelir: <b>${money(sumIn)} ‚Ç∫</b></span>
    <span class="chip">Gider: <b>${money(sumEx)} ‚Ç∫</b></span>
    <span class="chip">K√¢r: <b>${money(sumIn-sumEx)} ‚Ç∫</b></span>
    <span class="chip">Kayƒ±t: <b>${list.length}</b></span>`;
}
function exportCsv(){
  const rows = ["Tarih,Plaka,Gelir,Gider,K√¢r,Not"];
  state.data.forEach(r=>{
    const k=(r.income||0)-(r.expense||0);
    rows.push(`${r.date||""},${r.plate||""},${r.income||0},${r.expense||0},${k},"${(r.note||"").replace(/"/g,'""')}"`);
  });
  const blob = new Blob([rows.join("\n")], {type:"text/csv"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "sam_kayitlar.csv"; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),500);
}
el.btnFilter.addEventListener("click", renderTable);
el.btnClear.addEventListener("click", ()=>{ el.qPlate.value=""; renderTable(); });
el.btnCsv.addEventListener("click", exportCsv);

/* Grafik */
function drawChart(){
  const months={};
  state.data.forEach(r=>{
    if(!r.date) return;
    const [y,m] = r.date.split("-");
    const key = `${y}-${m}`;
    if(!months[key]) months[key] = {gelir:0,gider:0};
    months[key].gelir += (+r.income||0);
    months[key].gider += (+r.expense||0);
  });
  const labels = Object.keys(months).sort();
  const gelir = labels.map(k=>months[k].gelir);
  const gider = labels.map(k=>months[k].gider);

  if(state.chart){ state.chart.destroy(); state.chart=null; }
  state.chart = new Chart(el.chart, {
    type:"bar",
    data:{ labels, datasets:[
      {label:"Gelir", data:gelir, backgroundColor:"rgba(35,197,82,.7)"},
      {label:"Gider", data:gider, backgroundColor:"rgba(255,59,48,.7)"},
    ]},
    options:{plugins:{legend:{position:"bottom"}}, scales:{y:{beginAtZero:true}}}
  });
}

/* Bakƒ±m / ICS */
function toICSDate(d){ return d.replaceAll("-",""); }
function buildICS(items){
  const lines=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//SAM//TRUCK//TR"];
  items.forEach(x=>{
    const dt=toICSDate(x.service);
    lines.push("BEGIN:VEVENT");
    lines.push("UID:"+x.id+"@sam");
    lines.push("DTSTAMP:"+dt+"T090000Z");
    lines.push("DTSTART;VALUE=DATE:"+dt);
    lines.push("SUMMARY:"+(x.plate||"Tƒ±r")+" bakƒ±m/muayene");
    lines.push("DESCRIPTION:"+(x.note?x.note.replace(/\n/g," "):""));
    lines.push("END:VEVENT");
  });
  lines.push("END:VCALENDAR");
  return lines.join("\r\n");
}
function download(name,content,type){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([content],{type}));
  a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
}
function renderSvc(){
  el.tblSvcBody.innerHTML="";
  const today=new Date();
  const soon=new Date(); soon.setDate(today.getDate()+30);
  const list = state.data.filter(x=>x.service).sort((a,b)=> a.service.localeCompare(b.service));
  list.forEach(x=>{
    const d=new Date(x.service);
    const near=(d>=today && d<=soon) ? ' <span class="badge">yakla≈üƒ±yor</span>' : '';
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${x.service}${near}</td><td>${x.plate||""}</td><td>${x.note?"Bakƒ±m":"Muayene"}</td>
      <td><button class="ghost pill" data-id="${x.id}">.ics</button></td>`;
    tr.querySelector("button").addEventListener("click", ()=>{
      download(`sam_${x.plate||"bakim"}.ics`, buildICS([x]), "text/calendar");
    });
    el.tblSvcBody.appendChild(tr);
  });
}
el.btnAllIcs.addEventListener("click", ()=>{
  const items = state.data.filter(x=>x.service);
  if(!items.length){ alert("Bakƒ±m/muayene tarihi olan kayƒ±t yok."); return; }
  download("sam_bakimlar.ics", buildICS(items), "text/calendar");
});

/* ƒ∞lk y√ºkleme */
renderTable(); drawChart(); renderSvc();
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }
</script>
</body>
</html>
